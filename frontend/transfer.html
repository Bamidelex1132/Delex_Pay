<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bank Transfer - Delex Pay</title>
<link rel="icon" type="image/jpg" href="./assets/images/logo.1.jpg" />
<script src="./assets/js/debug.js"></script>
  <style>
  body {
    background: #0d1117;
    color: #e6edf3;
    font-family: 'Inter', Arial, sans-serif;
    padding: 2rem;
    display: flex;
    justify-content: center;
  }

  .card {
    width: 420px;
    background: #161b22;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 25px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.05);
  }

  h2 {
    text-align: center;
    color: #58a6ff;
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 24px;
  }

  .row {
    display: flex;
    justify-content: space-between;
    padding: 14px 16px;
    background: #1c2128;
    border-radius: 8px;
    margin-bottom: 14px;
    transition: background 0.25s;
  }
  .row:hover { background: #21262d; }

  .static-text {
    font-weight: 500;
    color: #8b949e;
    flex: 1;
  }
  .dynamic-text {
    font-weight: 600;
    color: #e6edf3;
    text-align: right;
    flex: 1;
  }

  .copy-btn {
    background: #238636;
    color: #fff;
    border: none;
    padding: 4px 8px;
    margin-left: 8px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.25s;
  }
  .copy-btn:hover { background: #2ea043; }

  label {
    display: block;
    font-weight: 500;
    margin: 16px 0 8px;
    color: #8b949e;
  }

  .proof-upload-box {
    border: 2px dashed #30363d;
    padding: 24px;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    background: #1c2128;
    transition: border-color 0.3s, background 0.3s;
  }
  .proof-upload-box:hover {
    border-color: #58a6ff;
    background: #21262d;
  }
  .proof-upload-box p {
    margin: 0;
    color: #8b949e;
    font-size: 0.95rem;
  }
  .proof-upload-box input[type=file] {
    display: none;
  }
  img#proofPreview {
    max-width: 100%;
    margin-top: 12px;
    border-radius: 8px;
    display: none;
  }

  button {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background: #238636;
    color: #fff;
    font-weight: 600;
    font-size: 1rem;
    margin-top: 12px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover { background: #2ea043; }
  button:disabled {
    background: #30363d;
    cursor: not-allowed;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(13, 17, 23, 0.9);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  .modal {
    background: #161b22;
    padding: 24px;
    border-radius: 12px;
    text-align: center;
    color: #e6edf3;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .modal h3 {
    color: #58a6ff;
    margin-bottom: 16px;
  }
</style>
</head>
<body>

<div class="card">
  <h2>Bank Transfer</h2>

  <div class="row">
    <div class="static-text">Bank:</div>
    <div class="dynamic-text" id="bank-name">Loading...</div>
  </div>
  <div class="row">
    <div class="static-text">Account Name:</div>
    <div class="dynamic-text" id="account-name">Loading...</div>
  </div>
  <div class="row">
    <div class="static-text">Account Number:</div>
    <div class="dynamic-text">
      <span id="account-number">Loading...</span>
      <button class="copy-btn" id="copyAccountBtn">Copy</button>
    </div>
  </div>
  <div class="row">
    <div class="static-text">Instructions:</div>
    <div class="dynamic-text" id="instructions">-</div>
  </div>
  <div class="row">
    <div class="static-text">Amount:</div>
    <div class="dynamic-text" id="amountVal">0</div>
  </div>
  <div class="row">
    <div class="static-text">Fee:</div>
    <div class="dynamic-text" id="feeVal">0</div>
  </div>
  <div class="row">
    <div class="static-text">Total:</div>
    <div class="dynamic-text" id="totalVal">0</div>
  </div>

  <label for="proof">Upload Proof (Image/PDF)</label>
  <div class="proof-upload-box" id="proofUploadBox">
    <p id="proofText">ðŸ“Ž Click or drag & drop your proof</p>
    <img id="proofPreview" src="" alt="Proof Preview" />
    <input type="file" id="proof" name="proof" accept="image/*,application/pdf" />
  </div>

  <button id="submitBtn" disabled>Submit Deposit</button>
  <div id="msg" style="margin-top:10px; color:#f87171;"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3>Deposit Submitted</h3>
    <p>Your deposit has been submitted successfully.</p>
    <button id="modalCloseBtn">Close</button>
  </div>
</div> 
      <script>
    const apiBase = "https://delex-pay.onrender.com";
    const amount = parseFloat(localStorage.getItem('depositAmount') || 0);
    const currency = localStorage.getItem('depositCurrency') || 'NGN';
    const method = localStorage.getItem('depositMethod') || 'bank';

    const bankNameEl = document.getElementById('bank-name');
    const accountNameEl = document.getElementById('account-name');
    const accountNumberEl = document.getElementById('account-number');
    const instructionsEl = document.getElementById('instructions');

    const amountVal = document.getElementById('amountVal');
    const feeVal = document.getElementById('feeVal');
    const totalVal = document.getElementById('totalVal');

    const proofInput = document.getElementById('proof');
    const proofUploadBox = document.getElementById('proofUploadBox');
    const proofPreview = document.getElementById('proofPreview');
    const proofText = document.getElementById('proofText');

    const submitBtn = document.getElementById('submitBtn');
    const msgEl = document.getElementById('msg');

    const modalOverlay = document.getElementById('modalOverlay');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    // Copy account number to clipboard
    document.getElementById('copyAccountBtn').addEventListener('click', () => {
      const textToCopy = accountNumberEl.textContent;
      if (!textToCopy || textToCopy === 'Loading...') return;
      navigator.clipboard.writeText(textToCopy).then(() => {
        alert('Account number copied to clipboard');
      }).catch(() => {
        alert('Failed to copy account number');
      });
    });

    // Click on proof box opens file selector
    proofUploadBox.addEventListener('click', () => proofInput.click());

    // When file is chosen, preview it and toggle text
    proofInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) {
        proofPreview.style.display = 'none';
        proofText.style.display = 'block';
        submitBtn.disabled = true;
        return;
      }

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          proofPreview.src = e.target.result;
          proofPreview.style.display = 'block';
          proofText.style.display = 'none';
        };
        reader.readAsDataURL(file);
      } else {
        proofPreview.style.display = 'none';
        proofText.style.display = 'none';
      }

      submitBtn.disabled = false;
    });

    async function loadDepositInfo() {
      try {
        const res = await fetch(`${apiBase}/api/deposit/${currency}`);
        if (!res.ok) throw new Error('Failed to load deposit info');
        const info = await res.json();

        bankNameEl.textContent = info.bankName;
        accountNameEl.textContent = info.accountName;
        accountNumberEl.textContent = info.accountNumber;
        instructionsEl.textContent = info.instructions || '-';

        const feeRate = amount < info.minAmount ? info.feeRateBelowMin : info.feeRateAboveMin;
        const fee = parseFloat((amount * feeRate).toFixed(2));
        const total = parseFloat((amount + fee).toFixed(2));

        amountVal.textContent = `${amount.toFixed(2)} ${currency}`;
        feeVal.textContent = `${fee.toFixed(2)} ${currency}`;
        totalVal.textContent = `${total.toFixed(2)} ${currency}`;

        submitBtn.dataset.fee = fee;
        submitBtn.dataset.total = total;
        submitBtn.dataset.currency = info.currency;
      } catch (err) {
        console.error(err);
        msgEl.textContent = 'Unable to load deposit details';
      }
    }

    submitBtn.addEventListener('click', async () => {
      msgEl.textContent = '';
      if (!proofInput.files[0]) {
        msgEl.textContent = 'Please upload proof';
        return;
      }

      const form = new FormData();
      form.append('proof', proofInput.files[0]);
      form.append('type', 'deposit');
      form.append('amount', amount);
      form.append('currency', submitBtn.dataset.currency || currency);
      form.append('method', method);

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${apiBase}/api/transactions/submit-transaction`, {
          method: 'POST',
          headers: token ? { 'Authorization': `Bearer ${token}` } : {},
          body: form
        });

        const data = await res.json();

        if (res.ok) {
          // Show modal popup instead of alert
          modalOverlay.style.display = 'flex';
        } else {
          msgEl.textContent = data.message || 'Submission failed';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit deposit';
        }
      } catch (err) {
        console.error(err);
        msgEl.textContent = 'Error submitting deposit';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit deposit';
      }
    });

    modalCloseBtn.addEventListener('click', () => {
      modalOverlay.style.display = 'none';
      localStorage.removeItem('depositAmount');
      localStorage.removeItem('depositCurrency');
      localStorage.removeItem('depositMethod');
      window.location.href = './user-dashboard.html';
    });

    loadDepositInfo();

</script>
</body>
</html>
