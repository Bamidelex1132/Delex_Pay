<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sell Crypto | Delex Pay</title>
  <link rel="icon" type="image/jpg" href="./assets/images/logo.1.jpg" />
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: 2rem auto;
    padding: 1rem;
    background: #f0f4f8;
  }
  label {
    display: block;
    margin: 0.5rem 0 0.2rem;
  }
  input, select, button {
    width: 100%;
    padding: 0.6rem;
    margin-bottom: 1rem;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  button {
    background: #004aad;
    color: white;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  #payoutDisplay {
    font-weight: bold;
    margin-bottom: 1rem;
  }
</style>
</head>
<body>

<h2>Sell Crypto</h2>

<form id="sellForm" enctype="multipart/form-data">
  <label for="coinSelect">Select Coin</label>
  <select id="coinSelect" name="coinSymbol" required>
    <option value="">-- Choose Coin --</option>
    <option value="pi">Pi</option>
    <option value="sidra">Sidra</option>
  </select>

  <div id="networkContainer" style="display:none;">
    <label for="networkSelect">Select Network</label>
    <select id="networkSelect" name="network"></select>
  </div>

  <label for="amount">Amount to Sell</label>
  <input type="number" id="amount" name="amount" min="0.0001" step="any" required />

  <p id="payoutDisplay">You will receive: ₦0.00</p>

  <label for="payoutDestination">Payout Destination (Wallet or Bank Details)</label>
  <input type="text" id="payoutDestination" name="payoutDestination" placeholder="Enter wallet or bank details" required />

  <label>
    <input type="checkbox" id="confirmationChecked" name="confirmationChecked" required />
    I confirm I want to sell this coin.
  </label>

  <label for="proofUpload">Upload Proof (optional)</label>
  <input type="file" id="proofUpload" name="proof" accept=".jpg,.jpeg,.png,.pdf" />

  <button type="submit" id="submitBtn" disabled>Submit Sell Order</button>
</form>

<script>
(async function() {
  const coinSelect = document.getElementById('coinSelect');
  const networkSelect = document.getElementById('networkSelect');
  const networkContainer = document.getElementById('networkContainer');
  const amountInput = document.getElementById('amount');
  const payoutDisplay = document.getElementById('payoutDisplay');
  const confirmationCheckbox = document.getElementById('confirmationChecked');
  const submitBtn = document.getElementById('submitBtn');

  const MARKUP_PERCENT = 5; // 5% markup on sell

  // Example networks for your coins (ideally fetched from backend)
  const coinNetworks = {
    pi: ['mainnet'],
    sidra: ['mainnet', 'testnet']
  };

  let currentRateNGN = 0; // live price per coin in NGN

  function updateNetworks(coin) {
    if (coinNetworks[coin] && coinNetworks[coin].length > 0) {
      networkContainer.style.display = 'block';
      networkSelect.innerHTML = '';
      coinNetworks[coin].forEach(net => {
        const option = document.createElement('option');
        option.value = net;
        option.textContent = net.charAt(0).toUpperCase() + net.slice(1);
        networkSelect.appendChild(option);
      });
    } else {
      networkContainer.style.display = 'none';
      networkSelect.innerHTML = '';
    }
  }

  async function fetchPrice(coin) {
    try {
      // Fetch live price in NGN from your backend or CoinGecko proxy API
      const res = await fetch(`/api/coins/price?coin=${coin}`);
      if (!res.ok) throw new Error('Price fetch failed');
      const data = await res.json();
      return data.ngnPrice || 0;
    } catch (err) {
      console.error(err);
      return 0;
    }
  }

  function calculatePayout(amount, rate) {
    if (!amount || amount <= 0 || !rate) return 0;
    const payoutPerCoin = rate * (1 - MARKUP_PERCENT / 100);
    return payoutPerCoin * amount;
  }

  function updatePayoutDisplay(amount) {
    const totalPayout = calculatePayout(amount, currentRateNGN);
    payoutDisplay.textContent = `You will receive: ₦${totalPayout.toFixed(2)}`;
  }

  coinSelect.addEventListener('change', async () => {
    const coin = coinSelect.value;
    updateNetworks(coin);
    if (coin) {
      currentRateNGN = await fetchPrice(coin);
      updatePayoutDisplay(parseFloat(amountInput.value));
    } else {
      currentRateNGN = 0;
      payoutDisplay.textContent = 'You will receive: ₦0.00';
    }
    validateForm();
  });

  amountInput.addEventListener('input', () => {
    updatePayoutDisplay(parseFloat(amountInput.value));
    validateForm();
  });

  confirmationCheckbox.addEventListener('change', validateForm);

  function validateForm() {
    submitBtn.disabled = !(coinSelect.value && amountInput.value > 0 && confirmationCheckbox.checked);
  }

  const sellForm = document.getElementById('sellForm');
  sellForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (submitBtn.disabled) return;

    const formData = new FormData(sellForm);

    // Optionally validate inputs here again

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
      const response = await fetch('/api/sell', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        alert(`Error: ${error.message || 'Sell failed'}`);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Sell Order';
        return;
      }

      alert('Sell order submitted successfully!');
      sellForm.reset();
      payoutDisplay.textContent = 'You will receive: ₦0.00';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submit Sell Order';
    } catch (err) {
      alert('Network error. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Sell Order';
    }
  });

})();
</script>

</body>
</html>
